name: CD - Deploy Continuo

on:
  # Acionado após o sucesso do workflow de CI
  workflow_run:
    workflows: ["CI - Integracao Continua"] # Deve ser o nome exato do 'name' em ci.yml
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    # A condicao garante que este job so roda se o CI foi bem-sucedido
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      pages: write        
      id-token: write     
    
    steps:
      # 1. Checkout (Necessario para usar actions)
      - name: 1. Checkout do Repositorio (Obrigatorio)
        uses: actions/checkout@v4
      
      # 2. Download do Artefato - PONTO CHAVE DA CORREÇÃO
      - name: 2. Download do Artefato de Construcao (Cross-Workflow)
        uses: actions/download-artifact@v4
        with:
          name: meu-site-estatico
          path: deploy/
          # <<-- ESSA LINHA RESOLVE O ERRO DE ARTEFATO NÃO ENCONTRADO
          run-id: ${{ github.event.workflow_run.id }} 
          
      # 3. Configura o ambiente para o GitHub Pages
      - name: 3. Configurar GitHub Pages
        uses: actions/configure-pages@v5
        
      # 4. Preparacao para o Deploy
      - name: 4. Preparar Arquivos para o Deploy
        run: |
          # O download-artifact armazena o artefato em deploy/meu-site-estatico/
          mkdir _site
          cp -r deploy/meu-site-estatico/* _site/

      # 5. Publicar Artefato para o Pages
      - name: 5. Publicar Artefato para o Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
          
      # 6. Concluir o Deploy
      - name: 6. Deploy no GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4